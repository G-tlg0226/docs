# HTTP/2 可行性分析归总

---

## [HTTP/2简介](https://developers.google.com/web/fundamentals/performance/HTTP/2/?hl=zh-cn)

* HTTP/2在2015年5月被批准，构建在Google [SPDY](https://zh.wikipedia.org/wiki/SPDY)协议基础之上，重要特性完全源自SPDY,Chrome在2016年年初停止了对SPDY的支持。

* HTTP/2是二进制（文本）协议，针对每个域只使用一个多路复用（`不同的请求共用一个TCP连接，允许多个资源并行下载，避免建立多个连接带来不必要的额外开销`）的连接，而不是每个文件一个连接；首部使用特制的HPACK协议压缩，SPDY中使用的gzip压缩。

* HTTP/2设计了复杂的优先级排定规则优先级排定规则，帮助浏览器首先请求最急需的文件。

## 客户端浏览器兼容性

* HTTP/2的前身SPDY的浏览器兼容性，[请看](https://caniuse.com/#search=spdy)
* HTTP/2的浏览器兼容性，[请看](https://caniuse.com/#search=http2)

## HTTP/2的优劣性

> 使用HTTP/2之前要先支持SSL/TLS（简称TLS）,而使用TLS的性能损耗大致可以被使用HTTP/2的性能提升抵销，不过得在实际应用之前先测试一下。

1. 服务器只使用一个连接，省掉多次建立连接的时间，并且通过一个连接上的多路利用实现最佳性能，而非同域切换时，新建TLS连接耗费时间, 而且单连接开销比较大，[HPACK](https://www.jianshu.com/p/f44b930cfcac)数据压缩算法会更新两端的查找表,让连接有状态，而破坏状态就意味着要重建查找表，另外单连接占用内存较多。下载文件较大时，而且在只有一个流的情况下，多路复用体现不出任何优势。

2. 压缩首部数据，简化Web应用，省掉HTTP/1.x时代所需的一些优化工作，比如拼接文件提高缓存利用率。

3. 优先级排定规则适合HTML、CSS、JavaScript、图片和有限多媒体的混合的页面，浏览器可以优先安排那些重要的文件请求，让页面的关键部分先出现，快出现。

4. 相对于 http/1.x ,http/2 使用TLS，从而让用户信息更安全，。

5. 并非所有业务场景都需要SSL，数据不需要保护，或者已经使用DRM或其他编码进行保护了，那么TLS的安全性可有可无，而且客户很可能不在乎数据的安全性

6. HTTP/1.x优化在支持HTTP/2的浏览器中会影响性能，因此可能需要花时间把它们推倒重来。

7. [HTTP/2测试工具](https://myssl.com/http2_check.html)

## 使用HTTP/2

* 合理部署HTTP/2或SPDY，使用代理服务器终止HTTP/2和TLS
  > 客户端使用 HTTP/2 连接代理服务器，代理服务器再用`其他协议`去连接应用服务器、数据库服务器等。支持HTTP/2的浏览器会基于HTTP/2运行应用，而旧版本浏览器则会继续使用HTTP/1.x运行你的应用，此时应该监测改变前后的性能，对于性能降低的情况，尽可能方便撤销HTTP2

* 决定采用HTTP/2之前，明确为HTTP/1.x优化的代码，有些优化会影响 http/2 的性能，例如：

  1. 分域存储: 并行请求文件，把文件分散到了不同的域里，CDN会自动这么做。其能够提升HTTP/1.x下的应用性能，即强制打开多个连接，并行地从不同的域获取文件，尽管实现与运维需要大量投入。但HTTP/2只有一个连接，分域时需要保证多个域名解析到同一个IP，证书包含通配符或多域证书。
  2. 雪碧图、合并文件、内联资源等。即将多个文件弄成一个，减少连接数，减少文件I/O，降低TCP线头阻塞时间，即尽可能将多的资源放入一个连接，而对HTTP/2(TLS)而言却会增加页面加载时间。因此，HTTP/2而言，应该专注于缓存调优，通用的法则：传输轻量、细粒度的资源，以便独立缓存和并行传输

* 基于浏览器的兼容性，对HTTP/1.x的优化操作需要与HTTP/2共存
* 减少DNS查询数，使用HTML头部的`<link rel='dns-prefetch' href='...' />`提前获取DNS记录
* 使用CDN，利用浏览器缓存
* 最小化请求大小，最小化响应大小，减少不必要的重定向